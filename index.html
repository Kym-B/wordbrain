<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wordbrains</title>
  <style>
    :root {
      --bg-start: #fdfbfb;
      --bg-end: #ebedee;
      --cell-filled: #4a90e2;
      --cell-filled-dark: #357ab8;
      --letter-color: #4a90e2;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      color: #333;
      background: radial-gradient(circle at top, var(--bg-start), var(--bg-end));
      transition: background 0.5s ease;
    }
    h1 { margin-bottom: 10px; font-size: 2rem; }
    #level-info, #score, #multiplier, #words-left { font-size: 1rem; margin: 4px 0; }
    #message.feedback { font-size: 1.2rem; margin-bottom: 10px; color: #4a90e2; }
    #crossword { display: grid; gap: 2px; margin: 20px 0; border: 2px solid #888; padding: 4px; }
    .cell { width: 40px; height: 40px; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; color: transparent; }
    .cell.filled { background: var(--cell-filled); color: #fff; transition: background 0.3s ease; }
    .block { width: 40px; height: 40px; background: #888; }
    .controls { display: flex; gap: 8px; margin: 10px 0; }
    .controls input { padding: 8px; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; width: 150px; }
    .controls button { padding: 8px 12px; font-size: 1rem; border: none; border-radius: 4px; background: var(--cell-filled); color: white; cursor: pointer; transition: background 0.3s ease; }
    .controls button:hover { background: var(--cell-filled-dark); }
    .dial-container { position: relative; width: 240px; height: 240px; margin: 20px 0; }
    .letters { position: relative; width: 100%; height: 100%; }
    .letter { position: absolute; width: 50px; height: 50px; background: linear-gradient(145deg,#ffffff,#e6e9ef); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.2rem; color: var(--letter-color); cursor:pointer; transform:scale(0); animation:pop 0.4s ease-out forwards; transition: color 0.3s ease; }
    @keyframes pop { 0% { transform:scale(0); } 80% { transform:scale(1.2); } 100% { transform:scale(1); } }
  </style>
</head>
<body>
  <h1>Wordbrains</h1>
  <div id="level-info"></div>
  <div id="score"></div>
  <div id="multiplier"></div>
  <div id="words-left"></div>

  <div id="message" class="feedback"></div>

  <div id="crossword"></div>

  <div class="dial-container"><div class="letters" id="letters"></div></div>

  <div class="controls">
    <input type="text" id="word-input" placeholder="Type or tap letters" />
    <button id="submit-btn">Submit</button>
    <button id="shuffle-btn">Shuffle</button>
    <button id="clear-btn">Clear</button>
  </div>

  <div class="filters">
    <label><input type="checkbox" id="filter-2"> Exclude 2-letter words</label>
    <label><input type="checkbox" id="filter-3"> Exclude 3-letter words</label>
  </div>

  <div id="bonus-words">
    <h2>Bonus Words:</h2>
    <ul id="bonus-list"></ul>
  </div>

  <script>
    const levelsConfig = [
      { maxLength: 4, rounds: 4 },
      { maxLength: 5, rounds: 5 },
      { maxLength: 6, rounds: 6 }
    ];

    let validWords = [];
    let currentWord = '';
    let letters = [];
    let foundWords = [];
    let bonusWords = [];
    let layoutWords = [];
    let wordsLeft = 0;
    let score = 0;
    let multiplier = 1.0;
    let currentLevel = 0;
    let roundsLeft = 0;
    const radius = 100;

    // DOM refs
    const levelInfoEl = document.getElementById('level-info');
    const scoreEl = document.getElementById('score');
    const multiplierEl = document.getElementById('multiplier');
    const wordsLeftEl = document.getElementById('words-left');
    const crosswordEl = document.getElementById('crossword');
    const lettersEl = document.getElementById('letters');
    const inputEl = document.getElementById('word-input');
    const msgEl = document.getElementById('message');
    const bonusListEl = document.getElementById('bonus-list');

    const shuffle = arr => arr.sort(() => Math.random() - 0.5);
    const validateMultiset = (w, b) => {
      const temp = b.toUpperCase().split('');
      for (const ch of w.toUpperCase()) {
        const idx = temp.indexOf(ch);
        if (idx < 0) return false;
        temp.splice(idx, 1);
      }
      return true;
    };

    function updateStats() {
      levelInfoEl.textContent = `Level ${currentLevel + 1}: up to ${levelsConfig[currentLevel].maxLength} letters (Rounds left: ${roundsLeft})`;
      scoreEl.textContent = `Score: ${score}`;
      multiplierEl.textContent = `Multiplier: ${multiplier.toFixed(1)}x`;
    }

    function updateWordsLeft() {
      wordsLeftEl.textContent = `Words left: ${wordsLeft}`;
    }

    function updateBonusList() {
      bonusListEl.innerHTML = '';
      bonusWords.forEach(w => {
        const li = document.createElement('li'); li.textContent = w; bonusListEl.appendChild(li);
      });
    }

    // fetch word library from GitHub
    fetch('https://raw.githubusercontent.com/Kym-B/wordbrain/main/wordbrains-wordlib.txt')
      .then(res => res.text())
      .then(txt => {
        validWords = txt.split(/[\r\n,]+/).map(w => w.trim().toLowerCase()).filter(w => w);
        initPuzzle();
      });

    function buildCrossword(main, words = []) {
      layoutWords = [...words];
      const maxLen = words.length ? Math.max(...words.map(w => w.length)) : 0;
      const width = main.length + maxLen;
      const height = 2 * maxLen + 1;
      const mainRow = maxLen;
      const used = Array.from({ length: height }, () => Array(width).fill(false));
      const crossArr = [];
      const mainCells = [];
      for (let i = 0; i < main.length; i++) {
        used[mainRow][i] = true;
        mainCells.push(`cell-${mainRow}-${i}`);
      }
      crossArr.push({ word: main, cells: mainCells });
            words.forEach(w => {
        // find intersection letter with main
        const inter = w.split('').find(ch => main.includes(ch));
        if (!inter) return;
        const iW = w.indexOf(inter);
        const jM = main.indexOf(inter);
        const startRow = mainRow - iW;
        // collect proposed cells
        const proposed = [];
        for (let j = 0; j < w.length; j++) {
          proposed.push([startRow + j, jM]);
        }
                // collision check and adjacency
        let canPlace = true;
        for (const [r, c] of proposed) {
          // bounds check
          if (r < 0 || r >= height || c < 0 || c >= width) { canPlace = false; break; }
          // collision: existing used with conflicting letter
          if (used[r][c]) {
            const cellEl = document.getElementById(`cell-${r}-${c}`);
            const existing = cellEl?.dataset?.char;
            const idxInW = proposed.findIndex(p => p[0] === r && p[1] === c);
            const ch = w[idxInW].toUpperCase();
            if (existing && existing !== ch) { canPlace = false; break; }
          }
          // adjacency: only allow adjacency at mainRow (intersection)
          if (r !== mainRow) {
            // check left/right neighbors
            const leftUsed = c-1 >=0 && used[r][c-1];
            const rightUsed = c+1 < width && used[r][c+1];
            if (leftUsed || rightUsed) { canPlace = false; break; }
          }
        }
        if (!canPlace) return;
        // place word
        const cells = [];
        for (const [r, c] of proposed) {
          used[r][c] = true;
          cells.push(`cell-${r}-${c}`);
        }
        crossArr.push({ word: w, cells });
      });
      crosswordEl.innerHTML = '';
      crosswordEl.style.gridTemplateColumns = `repeat(${width},40px)`;
      for (let r = 0; r < height; r++) {
        for (let c = 0; c < width; c++) {
          const cell = document.createElement('div');
          cell.className = used[r][c] ? 'cell' : 'block';
          cell.id = `cell-${r}-${c}`;
          crosswordEl.appendChild(cell);
        }
      }
      crossArr.forEach(({ word, cells }) => {
        word.split('').forEach((ch, j) => {
          const el = document.getElementById(cells[j]); if (el) el.dataset.char = ch.toUpperCase();
        });
      });
      window.crossLayout = crossArr;
    }

    function fillCrossword() {
      window.crossLayout.forEach(entry => {
        if (foundWords.includes(entry.word)) entry.cells.forEach(id => {
          const el = document.getElementById(id); if (el) { el.textContent = el.dataset.char; el.classList.add('filled'); }
        });
      });
    }

    function displayLetters() {
      if (!letters.length) return;
      lettersEl.innerHTML = '';
      letters.forEach((ltr, i) => {
        const angle = (360 / letters.length) * i - 90;
        const rad = angle * Math.PI / 180;
        const x = Math.cos(rad) * radius;
        const y = Math.sin(rad) * radius;
        const div = document.createElement('div'); div.className = 'letter'; div.textContent = ltr;
        div.style.left = `calc(50% + ${x}px - 25px)`; div.style.top = `calc(50% + ${y}px - 25px)`;
        div.style.animationDelay = `${i * 0.05}s`;
        div.onclick = () => inputEl.value += ltr.toLowerCase(); lettersEl.appendChild(div);
      });
    }

    function initPuzzle() {
      const { maxLength, rounds } = levelsConfig[currentLevel];
      let pool = validWords.filter(w => w.length <= maxLength);
      if (!pool.length) return;
      currentWord = shuffle(pool)[0];
      const excl2 = document.getElementById('filter-2').checked;
      const excl3 = document.getElementById('filter-3').checked;
      const sub = pool.filter(w => w !== currentWord && w.length >= 2 && (!excl2 || w.length !== 2) && (!excl3 || w.length !== 3) && validateMultiset(w, currentWord));
      layoutWords = shuffle(sub).slice(0, rounds);
      wordsLeft = rounds; roundsLeft = rounds; foundWords = []; bonusWords = [];
      updateStats(); updateWordsLeft(); updateBonusList();
      buildCrossword(currentWord, layoutWords);
      letters = shuffle(currentWord.toUpperCase().split(''));
      displayLetters(); msgEl.textContent = '';
    }

    function submitWord() {
      const guess = inputEl.value.trim().toLowerCase(); if (!guess) return;
      if (!validateMultiset(guess, currentWord)) { msgEl.textContent = 'Invalid!'; return; }
      if (!validWords.includes(guess)) { msgEl.textContent = 'Not in list!'; return; }
      if (foundWords.includes(guess) || bonusWords.includes(guess)) { msgEl.textContent = 'Already!'; return; }
      let pts;
      if (layoutWords.includes(guess)) {
        pts = Math.round(guess.length * 10 * multiplier); score += pts; multiplier += 0.1;
        foundWords.push(guess); fillCrossword(); wordsLeft--; roundsLeft--;
      } else {
        pts = 1; score += pts; bonusWords.push(guess); updateBonusList();
      }
      updateStats(); updateWordsLeft(); msgEl.textContent = `+${pts}!`;
      if (layoutWords.includes(guess) && wordsLeft <= 0) { if (currentLevel < levelsConfig.length - 1) currentLevel++; initPuzzle(); }
      inputEl.value = '';
    }

    inputEl.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); submitWord(); }});
    document.getElementById('submit-btn').addEventListener('click', submitWord);
    document.getElementById('shuffle-btn').addEventListener('click', () => { letters = shuffle(letters); displayLetters(); inputEl.value = ''; });
    document.getElementById('clear-btn').addEventListener('click', () => inputEl.value = '');
    document.getElementById('filter-2').addEventListener('change', initPuzzle);
    document.getElementById('filter-3').addEventListener('change', initPuzzle);
  </script>
</body>
</html>
