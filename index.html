<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Word Puzzle POC</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; display: flex; flex-direction: column; align-items: center; padding: 20px; color: #333; }
  h1 { margin-bottom: 10px; font-size: 2rem; }
  #level-info, #score, #multiplier, #words-left { font-size: 1rem; margin: 4px 0; }
  #crossword { display: grid; gap: 2px; margin: 20px 0; border: 2px solid #888; padding: 4px; grid-auto-rows: 40px; }
  .cell { width: 40px; height: 40px; background: #ddd; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; color: transparent; }
  .filled { background: #4a90e2 !important; color: #fff !important; }
  .controls { display: flex; gap: 8px; margin: 10px 0; }
  .controls input { padding: 8px; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; width: 150px; }
  .controls button { padding: 8px 12px; font-size: 1rem; border: none; border-radius: 4px; background: #4a90e2; color: white; cursor: pointer; }
  .dial-container { position: relative; width: 240px; height: 240px; margin: 20px 0; }
  .letters { position: relative; width: 100%; height: 100%; }
  .letter { position: absolute; width: 50px; height: 50px; background: linear-gradient(145deg,#ffffff,#e6e9ef); border-radius:50%; display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:#4a90e2;cursor:pointer;transform:scale(0);animation:pop 0.4s ease-out forwards; }
  @keyframes pop {0%{transform:scale(0)}80%{transform:scale(1.2)}100%{transform:scale(1)}}
</style>
</head>
<body>
  <h1>Wordbrains</h1>
  <div id="level-info">Level 1: up to 4 letters (Rounds left: 4)</div>
  <div id="score">Score: 0</div>
  <div id="multiplier">Multiplier: 1x</div>
  <div id="words-left">Words left: 0</div>

  <div id="crossword"></div>

  <div class="dial-container"><div class="letters" id="letters"></div></div>
  <div class="controls">
    <input type="text" id="word-input" placeholder="Type or tap letters" />
    <button id="submit-btn">Submit</button>
    <button id="shuffle-btn">Shuffle</button>
    <button id="clear-btn">Clear</button>
  </div>
  <input type="file" id="file-input" accept=".txt,.csv" />
  <div id="message"></div>

<script>
// Level configuration
const levelsConfig = [
  { maxLength: 4, rounds: 4 },
  { maxLength: 5, rounds: 5 },
  { maxLength: 6, rounds: 6 }
];

let validWords = [], currentWord = '', letters = [], foundWords = [], score = 0, multiplier = 1.0;
let currentPossibleWords = [], layoutWords = [], wordsLeft = 0;
let currentLevel = 0, roundsLeft = levelsConfig[0].rounds;
const radius = 100;

function initPuzzle() {
  if (!validWords.length) return;
  const { maxLength, rounds } = levelsConfig[currentLevel];
  const pool = validWords.filter(w => w.length <= maxLength);
  currentWord = pool[Math.floor(Math.random() * pool.length)];
  currentPossibleWords = validWords.filter(w => w.length >= 2 && validateMultiset(w, currentWord));
  // select and limit layout words
  layoutWords = shuffle(currentPossibleWords).slice(0, rounds);
  wordsLeft = layoutWords.length;
  wordsLeft = Math.min(currentPossibleWords.length, rounds);
  updateWordsLeft();
  buildCrossword(currentWord, layoutWords);
  letters = shuffle(currentWord.toUpperCase().split(''));
  displayLetters();
  updateStats();
  foundWords = [];
  document.getElementById('message').textContent = '';
}

function buildCrossword(main, words) {
  const cw = document.getElementById('crossword');
  cw.innerHTML = '';
  const width = main.length;
  const height = words.length + 1;
  cw.style.gridTemplateColumns = `repeat(${width},40px)`;
  // create grid cells
  for (let r = 0; r < height; r++) {
    for (let c = 0; c < width; c++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.id = `cell-${r}-${c}`;
      cw.appendChild(cell);
    }
  }
  // store layout and assign hidden letters
  window.crossLayout = [];
  words.forEach(w => {
    const intersectChar = w.split('').find(ch => main.includes(ch));
    const col = main.indexOf(intersectChar);
    w.split('').forEach((ch, j) => {
      const cell = document.getElementById(`cell-${j+1}-${col}`);
      if (cell) {
        cell.dataset.char = ch.toUpperCase();
      }
    });
    window.crossLayout.push({ word: w, rowStart: 1, col });
  });
}

function fillCrossword(guess) {
  window.crossLayout.forEach(entry => {
    if (entry.word === guess) {
      entry.word.split('').forEach((_, j) => {
        const cell = document.getElementById(`cell-${entry.rowStart+j}-${entry.col}`);
        if (cell) {
          cell.textContent = cell.dataset.char;
          cell.classList.add('filled');
        }
      });
    }
  });
}

function validateMultiset(w, base) {
  const tmp = base.toUpperCase().split('');
  for (const ch of w.toUpperCase()) {
    const i = tmp.indexOf(ch);
    if (i < 0) return false;
    tmp.splice(i, 1);
  }
  return true;
}

function displayLetters() {
  const cont = document.getElementById('letters'); cont.innerHTML = '';
  letters.forEach((ltr, i) => {
    const angle = (360 / letters.length) * i - 90;
    const rad = angle * Math.PI / 180;
    const x = Math.cos(rad) * radius;
    const y = Math.sin(rad) * radius;
    const div = document.createElement('div');
    div.className = 'letter'; div.textContent = ltr;
    div.style.left = `calc(50% + ${x}px - 25px)`;
    div.style.top = `calc(50% + ${y}px - 25px)`;
    div.style.animationDelay = `${i * 0.05}s`;
    div.onclick = () => document.getElementById('word-input').value += ltr.toLowerCase();
    cont.appendChild(div);
  });
}

function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

function updateStats() {
  document.getElementById('level-info').textContent =
    `Level ${currentLevel+1}: up to ${levelsConfig[currentLevel].maxLength} letters (Rounds left: ${roundsLeft})`;
  document.getElementById('score').textContent = `Score: ${score}`;
  document.getElementById('multiplier').textContent = `Multiplier: ${multiplier.toFixed(1)}x`;
}

function updateWordsLeft() { document.getElementById('words-left').textContent = `Words left: ${wordsLeft}`; }

const input = document.getElementById('word-input');
input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById('submit-btn').click(); } });

document.getElementById('submit-btn').onclick = () => {
  const guess = input.value.trim().toLowerCase(); const msg = document.getElementById('message');
  if (!guess) return;
  if (!validateMultiset(guess, currentWord)) msg.textContent = 'Invalid letters!';
  else if (!validWords.includes(guess)) msg.textContent = 'Not in list!';
  else if (foundWords.includes(guess)) msg.textContent = 'Already!';
  else {
    const pts = Math.round(guess.length * 10 * multiplier);
    score += pts; multiplier += 0.1; foundWords.push(guess); wordsLeft--; updateWordsLeft(); updateStats(); msg.textContent = `+${pts}!`;
    fillCrossword(guess);
    if (guess === currentWord) {
      roundsLeft--; if (roundsLeft <= 0 && currentLevel < levelsConfig.length-1) { currentLevel++; roundsLeft = levelsConfig[currentLevel].rounds; }
      setTimeout(initPuzzle, 500);
    }
  }
  input.value = '';
};

document.getElementById('shuffle-btn').onclick = () => { letters = shuffle(letters); displayLetters(); input.value = ''; };
document.getElementById('clear-btn').onclick = () => input.value = '';

const fileInput = document.getElementById('file-input');
fileInput.onchange = e => {
  const f = e.target.files[0]; if (!f) return;
  const reader = new FileReader(); reader.onload = ev => {
    validWords = ev.target.result.split(/[\r\n,]+/).map(w => w.trim().toLowerCase()).filter(w => w);
    currentLevel = 0; roundsLeft = levelsConfig[0].rounds; initPuzzle(); document.getElementById('message').textContent = `Loaded ${validWords.length}`;
  };
  reader.readAsText(f); e.target.value = '';
};

// Default word list
validWords = ['cater','react','trace','crate','eat','tea','cat','act']; initPuzzle();
</script>
</body>
</html>
